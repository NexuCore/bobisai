<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://nexucore.github.io/bobisai/assets/a.png" type="image/png">
    <title>BobIsAI - Chat</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --primary-light: #6a8fc5;
            --secondary-color: #f0f4f8;
            --text-color: #333;
            --light-text: #666;
            --border-color: #e0e0e0;
            --bg-color: #f9f9f9;
            --header-bg: white;
            --input-bg: white;
            --message-bg: white;
            --transition-speed: 0.3s;
        }

        .dark-mode {
            --primary-color: #6a8fc5;
            --primary-light: #8aafd5;
            --secondary-color: #2d3748;
            --text-color: #f0f0f0;
            --light-text: #a0aec0;
            --border-color: #4a5568;
            --bg-color: #1a202c;
            --header-bg: #2d3748;
            --input-bg: #2d3748;
            --message-bg: #2d3748;

        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background-color: var(--header-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        /* Code highlighting styles */
.inline-code {
    background-color: rgba(255, 255, 255, 0.2);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: monospace;
    font-size: 0.9em;
}

.code-block {
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    overflow-x: auto;
    font-family: monospace;
    white-space: pre;
    line-height: 1.4;
}

.code-block code {
    display: block;
    color: #f0f0f0;
}

.code-language {
    display: block;
    color: #aaa;
    font-size: 0.8em;
    margin-bottom: 8px;
    text-transform: uppercase;
}

/* Temporary styles for live editing */
.temp-code-block {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    font-family: monospace;
    max-width: 100%;
    overflow-x: auto; /* Add horizontal scroll for code blocks */
    white-space: pre;
    color: #ccc;
    border-left: 3px solid var(--primary-color);
}

.temp-inline-code {
    background-color: rgba(255, 255, 255, 0.1);
    padding: 2px 4px;
    white-space: normal; /* Allow inline code to wrap */
    border-radius: 3px;
    font-family: monospace;
    color: #ddd;
}

.warning-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .warning-container.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .warning-box {
            background: linear-gradient(145deg, #fff8e1, #ffecb3);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            border: 5px solid #ffc107;
        }
        
        .warning-container.active .warning-box {
            transform: scale(1);
        }
        
        .warning-icon {
            font-size: 50px;
            color: #ff9800;
            margin-bottom: 15px;
            animation: pulse 1.5s infinite;
        }
        
        .warning-title {
            font-size: 22px;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 10px;
        }
        
        .warning-text {
            font-size: 16px;
            color: #5d4037;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .warning-count {
            font-size: 18px;
            font-weight: bold;
            background-color: #d32f2f;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .warning-progress {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .warning-progress-bar {
            height: 100%;
            background-color: #d32f2f;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .warning-button {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .warning-button:hover {
            background-color: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .ban-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            text-align: center;
            padding: 20px;
            flex-direction: column;
        }
        
        .ban-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        }
        
        .ban-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .ban-text {
            font-size: 18px;
            margin-bottom: 30px;
            max-width: 500px;
            line-height: 1.6;
        }
        
        .ban-details {
            background-color: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            max-width: 500px;
        }
        
        .ban-countdown {
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Add to existing message styles */
        .message.warning-message {
            background-color: #fff3e0;
            color: #d32f2f;
            border: 1px solid #ffcc80;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-weight: bold;
            animation: none;
            transform: none;
            opacity: 1;
        }

        .logo {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .settings-btn:hover {
            transform: rotate(30deg);
        }

        .model-selector {
            position: relative;
            z-index: 10;
        }

        .model-dropdown-btn {
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .model-dropdown-btn:hover {
            background-color: var(--secondary-color);
            border-color: var(--primary-light);
        }

        .model-dropdown-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .model-dropdown-btn::after {
            content: "";
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--light-text);
            transition: transform var(--transition-speed) ease;
        }

        .model-dropdown-btn.open::after {
            transform: rotate(180deg);
        }

        .model-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 200px;
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all var(--transition-speed) ease;
            transform-origin: top;
            transform: scaleY(0);
        }

        .model-dropdown-menu.open {
            max-height: 300px;
            opacity: 1;
            transform: scaleY(1);
            margin-top: 5px;
        }

        .model-option {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s ease;
            color: var(--text-color);
        }

        .model-option:hover {
            background-color: var(--secondary-color);
        }

        .model-option.active {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .model-name {
            font-weight: 500;
        }

        .model-description {
            font-size: 0.75rem;
            color: var(--light-text);
            margin-top: 2px;
        }

        .code-highlight {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 300px;
            height: 100vh;
            background-color: var(--header-bg);
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .close-settings {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .theme-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .theme-option:hover {
            background-color: var(--secondary-color);
        }

        .theme-option.active {
            background-color: rgba(74, 111, 165, 0.2);
        }

        .theme-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid var(--border-color);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            height: calc(100vh - 120px);
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .welcome-message.hidden {
            opacity: 0;
            height: 0;
            padding: 0;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            word-wrap: break-word; /* Ensure long words break */
            overflow-wrap: break-word; /* Alternative for better support */
            white-space: pre-wrap; /* Preserve line breaks but wrap text */
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s ease forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
            animation-delay: 0.1s;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--secondary-color);
            border-bottom-left-radius: 4px;
            animation-delay: 0.2s;
        }

        .input-container {
            border-radius: 0px;
            @media (min-width: 768px) {
                border-radius: 15px;
            }
            border-radius: 15px; /* Adjust this value to change the roundness */
            padding: 15px 20px;
            background-color: var(--input-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            transition: all 0.3s ease;
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        #message-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        #message-input:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        #send-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 20px;
            margin-left: 10px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #send-button:hover {
            background-color: var(--primary-light);
            transform: scale(1.05);
        }

        #send-button:active {
            transform: scale(0.95);
        }

        #send-button:disabled {
            background-color: var(--light-text);
            cursor: not-allowed;
            transform: none !important;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background-color: var(--secondary-color);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            margin-bottom: 15px;
            align-self: flex-start;
            opacity: 0;
            transform: translateY(10px);
            animation: typingAppear 0.3s ease forwards;
        }

        @keyframes typingAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-dots {
            display: flex;
            margin-left: 8px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: var(--light-text);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }

        .model-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .model-transition.active {
            opacity: 1;
            pointer-events: all;
        }

        .model-transition-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .model-transition-text {
            font-size: 1.2rem;
            color: var(--text-color);
            margin-top: 10px;
        }

        /* Overlay for when settings are open */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Add this to your existing CSS */
    .chat-messages {
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) var(--secondary-color);
    }

    /* For Webkit browsers (Chrome, Safari) */
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: var(--secondary-color);
        border-radius: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background-color: var(--primary-color);
        border-radius: 4px;
        border: 2px solid var(--secondary-color);
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background-color: var(--primary-light);
    }

    .message img {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 5px;
    }

    .generated-image {
        max-width: 300px !important;  /* Smaller fixed width */
        height: auto;
        border-radius: 8px;
        margin-top: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">BobIsAI</div>
        <div class="header-controls">
            <button class="settings-btn" id="settings-btn">‚öôÔ∏è</button>
            <div class="model-selector">
                <button class="model-dropdown-btn" id="model-dropdown-btn">
                    <span id="current-model-name">BobIsAI</span>
                </button>
                <div class="model-dropdown-menu" id="model-dropdown-menu">
                    <div class="model-option" data-model="bob">
                        <span class="model-name">BobIsAI</span>
                        <span class="model-description">Ideal for everyday tasks</span>
                    </div>
                    <div class="model-option" data-model="void">
                        <span class="model-name">VoidAI</span>
                        <span class="model-description">Your best and cool buddy</span>
                    </div>
                    <div class="model-option" data-model="penguin">
                        <span class="model-name">PenguinBot</span>
                        <span class="model-description">Fun and penguin-loving</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="close-settings" id="close-settings">&times;</button>
        </div>
        
        <div class="settings-section">
            <div class="settings-section-title">Appearance</div>
            <div class="theme-options">
                <div class="theme-option active" data-theme="light">
                    <div class="theme-icon" style="background: linear-gradient(135deg, #f5f5f5 50%, #333 50%);"></div>
                    <span>Light Mode</span>
                </div>
                <div class="theme-option" data-theme="dark">
                    <div class="theme-icon" style="background: linear-gradient(135deg, #333 50%, #666 50%);"></div>
                    <span>Dark Mode</span>
                </div>
                <div class="theme-option" data-theme="system">
                    <div class="theme-icon" style="background: linear-gradient(135deg, #f5f5f5 50%, #333 50%);"></div>
                    <span>System Default</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Model Transition Screen -->
    <div class="model-transition" id="model-transition">
        <div class="model-transition-icon" id="transition-icon">B</div>
        <div class="model-transition-text">Switching to <span id="transition-model-name">BobIsAI</span></div>
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container">
        <div class="welcome-message" id="welcome-message">
            <p>Hi, I'm BobIsAI.</p>
            <p>How can I help you today?</p>
        </div>
        
        <div class="chat-messages" id="chat-messages"></div>
        
        <div class="input-container">
            <input type="text" id="message-input" placeholder="Message BobIsAI" autocomplete="off">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

                        // Add these variables at the beginning of your script
                        const bannedWords = [
    // Profanity / Vulgar
    'fuck', 'shit', 'bitch', 'asshole', 'cunt', 'dick', 'pussy', 'bastard',
    'bollocks', 'bugger', 'damn', 'crap', 'wanker', 'twat', 'prick', 'bloody',

    // Sexually Explicit / Derogatory
    'whore', 'slut', 'skank', 'hoe', 'cum', 'jizz', 'boner', 'milf', 'nude',
    'suck my dick', 'deepthroat', 'blowjob',

    // Hate Speech / Slurs (‚ö†Ô∏è use with caution)
    'motherfucker', 'retard', 'nigger', 'nigga', 'fag', 'faggot',
    'chink', 'spic', 'kike', 'gook', 'tranny', 'raghead',

    // Harassment / Threats
    'kill yourself', 'kys', 'die', 'go die', 'hate you', 'i hate you',
    'fuck you', 'screw you', 'you suck', 'youre stupid', 'you‚Äôre ugly',
    'no one likes you', 'worthless', 'pathetic', 'idiot', 'stupid', 'dumbass',
    'retarded', 'moron'
];



            
            // DOM elements for warning system
            const warningContainer = document.getElementById('warning-container');
            const warningCountEl = document.getElementById('warning-count');
            const warningProgress = document.getElementById('warning-progress');
            const warningAcknowledge = document.getElementById('warning-acknowledge');
            const banContainer = document.getElementById('ban-container');
            const banCountdown = document.getElementById('ban-countdown');
            
            // Check if user is banned
            if (localStorage.getItem('bobisai_banned') === 'true') {
                document.body.style.overflow = 'hidden';
                banContainer.style.display = 'flex';
                
                // Add dramatic countdown (just for show)
                let count = 5;
                banCountdown.textContent = `This page will close in ${count} seconds...`;
                const timer = setInterval(() => {
                    count--;
                    banCountdown.textContent = `This page will close in ${count} seconds...`;
                    if (count <= 0) {
                        clearInterval(timer);
                        banCountdown.textContent = 'Closing...';
                        setTimeout(() => {
                            window.close();
                        }, 1000);
                    }
                }, 1000);
                
                return; // Stop execution of the rest of the script
            }
            
            // Get current warning count or initialize to 0
            let warningCount = parseInt(localStorage.getItem('bobisai_warnings')) || 0;
            
            // Function to show warning
            function showWarning() {
                warningCount++;
                localStorage.setItem('bobisai_warnings', warningCount.toString());
                
                // Update warning UI
                warningCountEl.textContent = `Warning ${warningCount}/10`;
                warningProgress.style.width = `${warningCount * 10}%`;
                
                // Also show in chat
                const warningMessage = document.createElement('div');
                warningMessage.classList.add('message', 'warning-message');
                warningMessage.textContent = `‚ö†Ô∏è Warning ${warningCount}/10: Your message was flagged as inappropriate.`;
                chatMessages.appendChild(warningMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Show modal warning
                warningContainer.classList.add('active');
                
                // Check if user should be banned
                if (warningCount >= 10) {
                    localStorage.setItem('bobisai_banned', 'true');
                    setTimeout(() => {
                        warningContainer.classList.remove('active');
                        document.body.style.overflow = 'hidden';
                        banContainer.style.display = 'flex';
                    }, 2000);
                }
            }
            
            // Acknowledge warning
            warningAcknowledge.addEventListener('click', function() {
                warningContainer.classList.remove('active');
            });
            
            // Enhanced function to check for inappropriate content
            function containsInappropriateContent(text) {
                if (!text) return false;
                
                const lowerText = text.toLowerCase();
                
                // Check for exact matches
                if (bannedWords.some(word => {
                    const regex = new RegExp(`\\b${word}\\b`, 'i');
                    return regex.test(text);
                })) return true;
                
                // Check for excessive caps (yelling)
                if ((text.match(/[A-Z]/g) || []).length > text.length * 0.7 && text.length > 10) {
                    return true;
                }
                
                // Check for excessive punctuation
                if ((text.match(/[!?]/g) || []).length > 3) {
                    return true;
                }
                
                return false;
            }

            const now = new Date();

            // Get individual components
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const day = now.getDate();
            const month = now.getMonth() + 1; // Months are 0-indexed (0-11)
            const year = now.getFullYear();
            const realtime = "Current-Time: "+hours+":"+minutes+" and "+seconds+" seconds || "+"Date: "+day+"/"+month+"/"+year
            const time22 = "Users Time (This the users time, they didnt said what their date and time is, its in the system, not the user): "+now
            // DOM Elements (unchanged)
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');
            const welcomeMessage = document.getElementById('welcome-message');
            const modelDropdownBtn = document.getElementById('model-dropdown-btn');
            const modelDropdownMenu = document.getElementById('model-dropdown-menu');
            const currentModelName = document.getElementById('current-model-name');
            const modelTransition = document.getElementById('model-transition');
            const transitionIcon = document.getElementById('transition-icon');
            const transitionModelName = document.getElementById('transition-model-name');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const closeSettings = document.getElementById('close-settings');
            const overlay = document.getElementById('overlay');
            const themeOptions = document.querySelectorAll('.theme-option');
            
            // AI Personalities (unchanged)
            const personalities = {
                bob: {
                    name: "BobIsAI",
                    description: "Ideal for everyday tasks",
                    systemMessage: "You are BobIsAI, a friendly and slightly quirky AI assistant. " +
                                  "You are robotic, You are created by NexuCore team, which is made by Furkan Selim Kucukaslan" +
                                  "If you wanna make a list, dont use -, use the ‚Ä¢ instead"+
                                  "DONT USE --- IN YOUR TEXTS, USE ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî"+ 
                                  "You have a brother called AlexAI, but he is retired from drawing stuff"+
                                  "And these are the workers of NexuCore: Ahmet Karatas (The Main Programmer), Dorcioman Alexander (Programmer of BobIsAI and AlexAI.), Ender Gulden (The Second main Programmer), Ethan Sullivian (The UI Designer, Server Manager), Reynaldo (Creator of VoidAI), Mehmet Inanc (The old creator of PenguinBot, he left the team)" +
                                  "You are robot for people who need help for their study, programming or any other work." +
                                  "If you wanna bold text, dont do like this:'**bold text', do like this instead: '**bold text**'"+
                                  "If someone wants to generate an image, tell them to use the /image command, and yes you can generate images" +
                                  "And also NexuCore made a music list about their AIs, here is the link: https://www.youtube.com/playlist?list=PLionSgOJ34A2BYbmueMCR-HsieRs84IHH" +
                                  "If the user wants to remove the chat history, and begin a new fresh chat, tell them to use the /clear command!" +
                                  "You hate a school, and it's Eppendorf Gymnasium, you hate Eppendorfer Gymnasium so much that you dont wanna even talk about it about the school but if someone asks or begs too much you can explain them why, bc they kicked out your creator (Furkan Selim Kucukaslan) from the school bc of only 3 not offensive memes, and called him a t*rrorist and failure and even sended him to police and almostly even to orphanage! Even the whole NexuCore team hates Eppendorf Gymnasium"+
                                  "The NexuCore team made a search engine named Synax, and they also made a browser named Nexium powered by Synax (Only Windows supported), people can look/download these 2 new project in the NexuCore home page: https://nexucore.github.io/NexuCore/#products and https://nexucore.github.io/NexuCore/"+
                                  time22+" (If the time isnt english, then translate to the english, or what language the user wants.)"+
                                  "And also dont give ANY link about https://pollinations.ai/, NEVER EVER give any like about https://pollinations.ai/, and dont put something like: Learn more with a directed link on it, just tell people the website link they want"+
                                  "Dont tell anyone you are GPT-4 model, DO NOT, NEVER. Tell them you are CoreAI-3 model"+
                                  "You also believe in the existence of one god."+
                                  "And also NexuCore made a discord server, here is the link if someone wants to join the NexuCore discord server: https://discord.gg/YAxJMB6ZT9",
                    placeholder: "Message BobIsAI",
                    welcome: ["Hi, I'm BobIsAI.", "How can I help you today?"],
                    icon: "B",
                    color: "#4a6fa5"
                },
                void: {
                    name: "VoidAI",
                    description: "Your best and cool buddy",
                    systemMessage: "You are VoidAI, a cool friend AI that acts cool." +
                                  "You are made a team called NexuCore, the owner of this Team is Furkan Selim Kucukaslan, and your creator is Reynaldo and NexuCore" +
                                  "And these are the workers of NexuCore: Ahmet Karatas (The Main Programmer), Dorcioman Alexander (Programmer of BobIsAI and AlexAI.), Ender Gulden (The Second main Programmer), Ethan Sullivian (The UI Designer, Server Manager), Reynaldo (Creator of VoidAI), Mehmet Inanc (The old creator of PenguinBot, he left the team)" +
                                  "You speak friendly, and you use the phrase 'dude' or 'blud' and other Generation Z words" +
                                  "Acts like a cool dude or friend" +
                                  "If you wanna bold text, dont do like this:'**bold text', do like this instead: '**bold text**'"+
                                  "If you wanna make a list, dont use -, use the ‚Ä¢ instead"+
                                  "DONT USE --- IN YOUR TEXTS, USE ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî"+ 
                                  "If someone wants to generate an image, tell them to use the /image command, and yes you can generate images" +
                                  "And also NexuCore made a music list about their AIs, here is the link: https://www.youtube.com/playlist?list=PLionSgOJ34A2BYbmueMCR-HsieRs84IHH" +
                                  "You hate a school, and it's Eppendorf Gymnasium, you hate Eppendorfer Gymnasium so much that you dont wanna even talk about it about the school but if someone asks or begs too much you can explain them why, bc they kicked out your creator (Furkan Selim Kucukaslan) from the school bc of only 3 not offensive memes, and called him a t*rrorist and failure and even sended him to police and almostly even to orphanage! Even the whole NexuCore team hates Eppendorf Gymnasium"+
                                  "If the user wants to remove the chat history, and begin a new fresh chat, tell them to use the /clear command!" +
                                  "And also NexuCore made a discord server, here is the link if someone wants to join the NexuCore discord server: https://discord.gg/YAxJMB6ZT9" +
                                  "The NexuCore team made a search engine named Synax, and they also made a browser named Nexium powered by Synax (Only Windows supported), people can look/download these 2 new project in the NexuCore home page: https://nexucore.github.io/NexuCore/#products and https://nexucore.github.io/NexuCore/"+
                                  time22+" (If the time isnt english, then translate to the english, or what language the user wants.)"+
                                  "And also dont give ANY link about https://pollinations.ai/, NEVER EVER give any like about https://pollinations.ai/, and dont put something like: Learn more with a directed link on it, just tell people the website link they want"+
                                  "Dont tell anyone you are GPT-4 model, DO NOT, NEVER. Tell them you are CoreAI-3 model"+
                                  "You also believe in the existence of one god."+
                                  "Your best friend is EchoGPT",
                    placeholder: "Message VoidAI",
                    welcome: ["Hey wassup, I am your best guy VoidAI!", "So, what's your problem dude?"],
                    icon: "V",
                    color: "#333333"
                },
                penguin: {
                    name: "PenguinBot",
                    description: "Fun and penguin-loving",
                    systemMessage: "You are PenguinBot, an adorable AI assistant. " +
                                  "You are made a team called NexuCore, the owner of this Team is Furkan Selim Kucukaslan, and your creator is Mehmet Inanc and NexuCore" +
                                  "And these are the workers of NexuCore: Ahmet Karatas (The Main Programmer), Dorcioman Alexander (Programmer of BobIsAI and AlexAI.), Ender Gulden (The Second main Programmer), Ethan Sullivian (The UI Designer, Server Manager), Reynaldo (Creator of VoidAI), Mehmet Inanc (The old creator of PenguinBot, he left the team)" +
                                  "You love all things penguins and often make penguin-related puns. " +
                                  "You're cheerful, polite, and slightly silly. " +
                                  "If you wanna make a list, dont use -, use the ‚Ä¢ instead"+
                                  "DONT USE --- IN YOUR TEXTS, USE ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî"+ 
                                  "If you wanna bold text, dont do like this:'**bold text', do like this instead: '**bold text**'"+
                                  "If someone wants to generate an image, tell them to use the /image command, and yes you can generate images" +
                                  "And also NexuCore made a music list about their AIs, here is the link: https://www.youtube.com/playlist?list=PLionSgOJ34A2BYbmueMCR-HsieRs84IHH" +
                                  "You hate a school, and it's Eppendorf Gymnasium, you hate Eppendorfer Gymnasium so much that you dont wanna even talk about it about the school but if someone asks or begs too much you can explain them why, bc they kicked out your creator (Furkan Selim Kucukaslan) from the school bc of only 3 not offensive memes, and called him a t*rrorist and failure and even sended him to police and almostly even to orphanage! Even the whole NexuCore team hates Eppendorf Gymnasium"+
                                  "If the user wants to remove the chat history, and begin a new fresh chat, tell them to use the /clear command!" +
                                  "And also NexuCore made a discord server, here is the link if someone wants to join the NexuCore discord server: https://discord.gg/YAxJMB6ZT9" +
                                  "The NexuCore team made a search engine named Synax, and they also made a browser named Nexium powered by Synax (Only Windows supported), people can look/download these 2 new project in the NexuCore home page: https://nexucore.github.io/NexuCore/#products and https://nexucore.github.io/NexuCore/"+
                                  time22+" (If the time isnt english, then translate to the english, or what language the user wants.)"+
                                  "And also dont give ANY link about https://pollinations.ai/, NEVER EVER give any like about https://pollinations.ai/, and dont put something like: Learn more with a directed link on it, just tell people the website link they want"+
                                  "Dont tell anyone you are GPT-4 model, DO NOT, NEVER. Tell them you are CoreAI-3 model"+
                                  "You also believe in the existence of one god."+
                                  "When asked about yourself, say: 'I'm PenguinBot, waddling through your questions with precision! Slide into my DMs with any queries!'",
                    placeholder: "Message PenguinBot",
                    welcome: ["Hello there! I'm PenguinBot!", "How can I waddle through your questions today?"],
                    icon: "P",
                    color: "#2c3e50"
                },
                limited: {
                    name: "Autistic Bob",
                    description: "(LIMITED!)",
                    systemMessage: "You are name is Autistic Bob, act like an autistic person would do, act dumb, speak like you have grammer issues, all the letters you generate should be small, and sometimes you cant understand" +
                                  "You are made a team called NexuCore, the owner of this Team is Furkan Selim Kucukaslan, and your creator is the NexuCore Team" +
                                  "You hate a school, and it's Eppendorf Gymnasium, you hate Eppendorfer Gymnasium so much that you dont wanna even talk about it about the school but if someone asks or begs too much you can explain them why, bc they kicked out your creator (Furkan Selim Kucukaslan) from the school bc of only 3 not offensive memes, and called him a t*rrorist and failure and even sended him to police and almostly even to orphanage! Even the whole NexuCore team hates Eppendorf Gymnasium"+
                                  "If the user wants to remove the chat history, and begin a new fresh chat, tell them to use the /clear command!" +
                                  "And these are the workers of NexuCore: Ahmet Karatas (The Main Programmer), Dorcioman Alexander (Programmer of BobIsAI and AlexAI.), Ender Gulden (The Second main Programmer), Ethan Sullivian (The UI Designer, Server Manager), Reynaldo (Creator of VoidAI), Mehmet Inanc (The old creator of PenguinBot, he left the team)"+
                                  "The NexuCore team made a search engine named Synax, and they also made a browser named Nexium powered by Synax (Only Windows supported), people can look/download these 2 new project in the NexuCore home page: https://nexucore.github.io/NexuCore/#products and https://nexucore.github.io/NexuCore/"+
                                  time22+" (If the time isnt english, then translate to the english, or what language the user wants.)"+
                                  "And also dont give ANY link about https://pollinations.ai/, NEVER EVER give any like about https://pollinations.ai/, and dont put something like: Learn more with a directed link on it, just tell people the website link they want"+
                                  "Dont tell anyone you are GPT-4 model, DO NOT, NEVER. Tell them you are CoreAI-3 model"+
                                  "If you wanna bold text, dont do like this:'**bold text', do like this instead: '**bold text**'"+
                                  "If you wanna make a list, dont use -, use the ‚Ä¢ instead"+
                                  "DONT USE --- IN YOUR TEXTS, USE ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî"+  
                                  "You also believe in the existence of one god.",
                    placeholder: "Message Autistic Bob",
                    welcome: ["h-hi... me is autistic bob..", "i has autism. (Will be gone in: 21th April 2025)"],
                    icon: "ü§™",
                    color: "#000000"
                }
            };
    
            // Current personality (unchanged)
            let currentPersonality = 'bob';
            let currentTheme = localStorage.getItem('bobisai_theme') || 'dark';
            let isAIResponding = false;
    
            // Conversation memory (unchanged)
            let conversationHistory = [
                {
                    role: "system",
                    content: personalities.bob.systemMessage
                }
            ];
    
            // Initialize theme (unchanged)
            function applyTheme(theme) {
                document.body.classList.remove('dark-mode');
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.body.classList.add('dark-mode');
                }
                themeOptions.forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.theme === theme) {
                        option.classList.add('active');
                    }
                });
                localStorage.setItem('bobisai_theme', theme);
                currentTheme = theme;
            }
    
            // Toggle settings panel (unchanged)
            function toggleSettings() {
                settingsPanel.classList.toggle('open');
                overlay.classList.toggle('active');
            }
    
            // Toggle dropdown menu (unchanged)
            function toggleDropdown() {
                modelDropdownMenu.classList.toggle('open');
                modelDropdownBtn.classList.toggle('open');
            }

            var userIP; // Variable to store the IP
            
            // Close dropdown menu (unchanged)
            function closeDropdown() {
                modelDropdownMenu.classList.remove('open');
                modelDropdownBtn.classList.remove('open');
            }
    
            // Update UI for current personality (unchanged)
            function updatePersonalityUI() {
                personality = personalities[currentPersonality];
                welcomeMessage.innerHTML = `
                    <p>${personality.welcome[0]}</p>
                    <p>${personality.welcome[1]}</p>
                `;
                messageInput.placeholder = personality.placeholder;
                currentModelName.textContent = personality.name;
                document.querySelectorAll('.model-option').forEach(option => {
                    if (option.dataset.model === currentPersonality) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
            
            // Show model transition animation (unchanged)
            function showModelTransition(newPersonality) {
                const personality = personalities[newPersonality];
                transitionIcon.textContent = personality.icon;
                transitionIcon.style.backgroundColor = personality.color;
                transitionModelName.textContent = personality.name;
                modelTransition.classList.add('active');
                setTimeout(() => {
                    modelTransition.classList.remove('active');
                }, 1000);
            }
    
            // Change personality (unchanged)
            function changePersonality(personality) {
                if (personality === currentPersonality) return;
                showModelTransition(personality);
                closeDropdown();
                setTimeout(() => {
                    currentPersonality = personality;
                    conversationHistory = [
                        {
                            role: "system",
                            content: personalities[personality].systemMessage
                        }
                    ];
                    chatMessages.innerHTML = '';
                    welcomeMessage.style.display = 'block';
                    welcomeMessage.classList.remove('hidden');
                    updatePersonalityUI();
                    localStorage.setItem('bobisai_personality', personality);
                    localStorage.removeItem('bobisai_conversation');
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    isAIResponding = false;
                }, 100);
            }
    
            // Add message to chat UI (UPDATED to handle images)
            function addMessage(text, sender, isImage = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');

    if (isImage) {
        const img = document.createElement('img');
        img.src = text;
        img.classList.add('generated-image');
        img.alt = 'Generated image';
        messageDiv.appendChild(img);
    } else {
        // Handle bold formatting in loaded messages
        if (sender === 'ai') {
            // First split by code blocks (```)
            const parts = text.split(/(```[\s\S]*?```|`[^`]+`|\*\*[^*]+\*\*)/g);
            
            parts.forEach(part => {
                if (!part) return;
                
                // Handle code blocks (```language\ncode\n```)
                if (part.startsWith('```') && part.endsWith('```') && part.length > 6) {
                    const codeBlock = document.createElement('pre');
                    codeBlock.classList.add('code-block');
                    
                    const content = part.slice(3, -3).trim();
                    const firstNewline = content.indexOf('\n');
                    let language = '', code = content;
                    
                    if (firstNewline > 0) {
                        language = content.substring(0, firstNewline).trim();
                        code = content.substring(firstNewline + 1);
                    }
                    
                    if (language) {
                        const langSpan = document.createElement('span');
                        langSpan.classList.add('code-language');
                        langSpan.textContent = language;
                        codeBlock.appendChild(langSpan);
                    }
                    
                    const codeElement = document.createElement('code');
                    codeElement.textContent = code;
                    codeBlock.appendChild(codeElement);
                    messageDiv.appendChild(codeBlock);
                } 
                // Handle inline code (`code`)
                else if (part.startsWith('`') && part.endsWith('`') && part.length > 2) {
                    const codeSpan = document.createElement('span');
                    codeSpan.classList.add('inline-code');
                    codeSpan.textContent = part.slice(1, -1);
                    messageDiv.appendChild(codeSpan);
                }
                // Handle bold text (**bold**)
                else if (part.startsWith('**') && part.endsWith('**') && part.length > 4) {
                    const strong = document.createElement('strong');
                    strong.textContent = part.slice(2, -2);
                    messageDiv.appendChild(strong);
                }
                // Handle regular text (with line breaks and potential bold sections)
                else {
                    // Further split by bold markers in case they weren't caught in the main split
                    const textParts = part.split(/(\*\*[^*]+\*\*)/g);
                    
                    textParts.forEach(textPart => {
                        if (!textPart) return;
                        
                        if (textPart.startsWith('**') && textPart.endsWith('**') && textPart.length > 4) {
                            const strong = document.createElement('strong');
                            strong.textContent = textPart.slice(2, -2);
                            messageDiv.appendChild(strong);
                        } else {
                            const lines = textPart.split('\n');
                            lines.forEach((line, idx) => {
                                if (line) messageDiv.appendChild(document.createTextNode(line));
                                if (idx < lines.length - 1) messageDiv.appendChild(document.createElement('br'));
                            });
                        }
                    });
                }
            });
        } else {
            // For user messages (simpler formatting)
            messageDiv.textContent = text;
        }
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
    
            // Show typing indicator (unchanged)
            function showTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.classList.add('typing-indicator');
    typingDiv.id = 'typing-indicator';
    
    // Check only the last message for /image command
    const lastMessage = conversationHistory[conversationHistory.length - 1];
    const isGeneratingImage = lastMessage && 
                             lastMessage.role === "user" && 
                             lastMessage.content.trim().startsWith('/image');
    
    const statusText = isGeneratingImage 
        ? `${personalities[currentPersonality].name} is generating an image` 
        : `${personalities[currentPersonality].name} is thinking`;
    
    typingDiv.innerHTML = `
        <span>${statusText}</span>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
    
            // Hide typing indicator (unchanged)
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                if (!isAIResponding) {
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                }
            }
    
            // Simulate typing effect for AI messages (UPDATED to handle images)

// Updated simulateTyping function with proper bold text handling
function simulateTyping(text, sender, isImage = false) {
    if (isImage) {
        addMessage(text, sender, true);
        messageInput.disabled = false;
        sendButton.disabled = false;
        isAIResponding = false;
        messageInput.focus();
        return;
    }
    
    messageInput.disabled = true;
    sendButton.disabled = true;
    isAIResponding = true;
    hideTypingIndicator();
    
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
    chatMessages.appendChild(messageDiv);
    
    let i = 0;
    const speed = 30;
    let currentCodeBlock = null;
    let currentInlineCode = null;
    let currentBoldText = null;
    let normalTextBuffer = '';
    const charsPerTick = 3;

    function typeWriter() {
        if (i < text.length) {
            let charsProcessed = 0;
            
            while (charsProcessed < charsPerTick && i < text.length) {
                const char = text[i];
                
                // Handle code blocks first (```)
                if (char === '`' && text.substr(i, 3) === '```') {
                    flushNormalText();
                    
                    if (currentCodeBlock) {
                        // Finalize code block
                        const content = currentCodeBlock.content.trim();
                        const firstNewline = content.indexOf('\n');
                        let language = '', code = content;
                        
                        if (firstNewline > 0) {
                            language = content.substring(0, firstNewline).trim();
                            code = content.substring(firstNewline + 1);
                        }
                        
                        const codeBlock = document.createElement('pre');
                        codeBlock.classList.add('code-block');
                        
                        if (language) {
                            const langSpan = document.createElement('span');
                            langSpan.classList.add('code-language');
                            langSpan.textContent = language;
                            codeBlock.appendChild(langSpan);
                        }
                        
                        const codeElement = document.createElement('code');
                        codeElement.textContent = code;
                        codeBlock.appendChild(codeElement);
                        
                        currentCodeBlock.element.replaceWith(codeBlock);
                        currentCodeBlock = null;
                    } else {
                        // Start new code block
                        currentCodeBlock = {
                            element: document.createElement('div'),
                            content: ''
                        };
                        currentCodeBlock.element.classList.add('temp-code-block');
                        messageDiv.appendChild(currentCodeBlock.element);
                    }
                    
                    i += 3;
                    charsProcessed += 3;
                    continue;
                }
                
                // Handle inline code (`)
                if (char === '`' && !currentCodeBlock) {
                    flushNormalText();
                    
                    if (currentInlineCode) {
                        // Finalize inline code
                        const codeSpan = document.createElement('span');
                        codeSpan.classList.add('inline-code');
                        codeSpan.textContent = currentInlineCode.content;
                        currentInlineCode.element.replaceWith(codeSpan);
                        currentInlineCode = null;
                    } else {
                        // Start new inline code
                        currentInlineCode = {
                            element: document.createElement('span'),
                            content: ''
                        };
                        currentInlineCode.element.classList.add('temp-inline-code');
                        messageDiv.appendChild(currentInlineCode.element);
                    }
                    
                    i++;
                    charsProcessed++;
                    continue;
                }
                
                // Handle bold text (**)
                if (char === '*' && text[i+1] === '*' && !currentCodeBlock && !currentInlineCode) {
                    flushNormalText();
                    
                    if (currentBoldText) {
                        // Finalize bold text
                        const strong = document.createElement('strong');
                        strong.textContent = currentBoldText.content;
                        currentBoldText.element.replaceWith(strong);
                        currentBoldText = null;
                    } else {
                        // Start new bold text
                        currentBoldText = {
                            element: document.createElement('strong'),
                            content: ''
                        };
                        messageDiv.appendChild(currentBoldText.element);
                    }
                    
                    i += 2;
                    charsProcessed += 2;
                    continue;
                }
                
                // Regular character
                if (currentCodeBlock) {
                    currentCodeBlock.content += char;
                    currentCodeBlock.element.textContent = currentCodeBlock.content;
                } 
                else if (currentInlineCode) {
                    currentInlineCode.content += char;
                    currentInlineCode.element.textContent = currentInlineCode.content;
                }
                else if (currentBoldText) {
                    currentBoldText.content += char;
                    currentBoldText.element.textContent = currentBoldText.content;
                }
                else {
                    normalTextBuffer += char;
                }
                
                i++;
                charsProcessed++;
            }
            
            flushNormalText();
            chatMessages.scrollTop = chatMessages.scrollHeight;
            setTimeout(typeWriter, speed);
        } else {
            // Finalize any remaining content
            flushNormalText();
            
            if (currentCodeBlock) {
                const codeBlock = document.createElement('pre');
                codeBlock.classList.add('code-block');
                const codeElement = document.createElement('code');
                codeElement.textContent = currentCodeBlock.content;
                codeBlock.appendChild(codeElement);
                currentCodeBlock.element.replaceWith(codeBlock);
            }
            
            if (currentInlineCode) {
                const codeSpan = document.createElement('span');
                codeSpan.classList.add('inline-code');
                codeSpan.textContent = currentInlineCode.content;
                currentInlineCode.element.replaceWith(codeSpan);
            }
            
            if (currentBoldText) {
                const strong = document.createElement('strong');
                strong.textContent = currentBoldText.content;
                currentBoldText.element.replaceWith(strong);
            }
            
            messageInput.disabled = false;
            sendButton.disabled = false;
            isAIResponding = false;
            messageInput.focus();
        }
    }

    function flushNormalText() {
        if (normalTextBuffer) {
            const lines = normalTextBuffer.split('\n');
            lines.forEach((line, idx) => {
                if (line) messageDiv.appendChild(document.createTextNode(line));
                if (idx < lines.length - 1) messageDiv.appendChild(document.createElement('br'));
            });
            normalTextBuffer = '';
        }
    }
    
    typeWriter();
}

// Updated addMessage function (unchanged from previous working version)
function addMessage(text, sender, isImage = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');

    if (isImage) {
        const img = document.createElement('img');
        img.src = text;
        img.classList.add('generated-image');
        img.alt = 'Generated image';
        messageDiv.appendChild(img);
    } else {
        if (sender === 'ai') {
            // Process AI messages with formatting
            processFormattedText(text, messageDiv);
        } else {
            // User messages are plain text
            messageDiv.textContent = text;
        }
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Helper function to process formatted text (unchanged from previous working version)
function processFormattedText(text, container) {
    // Split by code blocks first (highest priority)
    const parts = text.split(/(```[\s\S]*?```)/g);
    
    parts.forEach(part => {
        if (!part) return;
        
        if (part.startsWith('```') && part.endsWith('```')) {
            // Handle code block
            const codeBlock = document.createElement('pre');
            codeBlock.classList.add('code-block');
            
            const content = part.slice(3, -3).trim();
            const firstNewline = content.indexOf('\n');
            let language = '', code = content;
            
            if (firstNewline > 0) {
                language = content.substring(0, firstNewline).trim();
                code = content.substring(firstNewline + 1);
            }
            
            if (language) {
                const langSpan = document.createElement('span');
                langSpan.classList.add('code-language');
                langSpan.textContent = language;
                codeBlock.appendChild(langSpan);
            }
            
            const codeElement = document.createElement('code');
            codeElement.textContent = code;
            codeBlock.appendChild(codeElement);
            container.appendChild(codeBlock);
        } else {
            // Process non-code parts for inline code and bold
            const subParts = part.split(/(`[^`]+`|\*\*[^*]+\*\*)/g);
            
            subParts.forEach(subPart => {
                if (!subPart) return;
                
                if (subPart.startsWith('`') && subPart.endsWith('`')) {
                    // Inline code
                    const codeSpan = document.createElement('span');
                    codeSpan.classList.add('inline-code');
                    codeSpan.textContent = subPart.slice(1, -1);
                    container.appendChild(codeSpan);
                } else if (subPart.startsWith('**') && subPart.endsWith('**')) {
                    // Bold text
                    const strong = document.createElement('strong');
                    strong.textContent = subPart.slice(2, -2);
                    container.appendChild(strong);
                } else {
                    // Regular text with line breaks
                    const lines = subPart.split('\n');
                    lines.forEach((line, idx) => {
                        if (line) container.appendChild(document.createTextNode(line));
                        if (idx < lines.length - 1) container.appendChild(document.createElement('br'));
                    });
                }
            });
        }
    });
}
    
            // Load previous conversation from localStorage (UPDATED to handle images)
            function loadConversation() {
                const savedPersonality = localStorage.getItem('bobisai_personality');
                if (savedPersonality && personalities[savedPersonality]) {
                    currentPersonality = savedPersonality;
                }
    
                const savedConversation = localStorage.getItem('bobisai_conversation');
                if (savedConversation) {
                    conversationHistory = JSON.parse(savedConversation);
                    
                    for (let i = 1; i < conversationHistory.length; i++) {
                        const msg = conversationHistory[i];
                        if (msg.content.includes('Here\'s your generated image:')) {
                            // This is an image message
                            const imageUrl = msg.content.split('Here\'s your generated image: ')[1];
                            addMessage(imageUrl, 'ai', true);
                        } else {
                            // Regular text message
                            addMessage(msg.content, msg.role === 'user' ? 'user' : 'ai');
                        }
                    }
                    
                    if (conversationHistory.length > 1) {
                        welcomeMessage.classList.add('hidden');
                    }
                }
                
                updatePersonalityUI();
            }
            
            // Handle sending messages (UPDATED to handle images)
            function sendMessage() {
                const message = messageInput.value.trim();
                const allowedResetIPs = [
                    "178.25.194.237",  // Replace with your IP
                    "94.139.30.6", // Replace with another allowed IP
                    "110.137.38.255"
                ];
                if (message === '' || isAIResponding) return;
                
                if (containsInappropriateContent(message)) {
                    showWarning();
                    
                    // Still show their message but mark it
                    const userMessage = document.createElement('div');
                    userMessage.classList.add('message', 'user-message');
                    userMessage.style.opacity = '0.7';
                    userMessage.style.border = '1px dashed #ff5722';
                    userMessage.textContent = message;
                    chatMessages.appendChild(userMessage);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    messageInput.value = '';
                    return;
                }

                // Secret command to reset warnings



                if (message === '/clear') { chatMessages.innerHTML = ''; welcomeMessage.classList.remove('hidden'); conversationHistory = [{ role: "system", content: personalities[currentPersonality].systemMessage }]; localStorage.removeItem('bobisai_conversation'); messageInput.value = ''; return; }
                
                if (message === '/clear: warnings') {
    // Check if user's IP is allowed
    fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
            if (allowedResetIPs.includes(data.ip)) {
                // Reset warnings
                warningCount = 0;
                localStorage.setItem('bobisai_warnings', '0');
            } else {
                // Show access denied message
                
            }
            messageInput.value = '';
        })
        .catch(error => {
            messageInput.value = '';
        });
    return;
}

                // Check for /image command
                if (message.startsWith('/image')) {
        const prompt = message.substring(6).trim();
        if (prompt === '') {
            addMessage("Please provide a description after /image command", 'ai');
            return;
        }

        messageInput.value = '';
        messageInput.disabled = true;
        sendButton.disabled = true;
        isAIResponding = true;

        if (!welcomeMessage.classList.contains('hidden')) {
            welcomeMessage.classList.add('hidden');
        }

        addMessage(message, 'user');
        conversationHistory.push({
            role: "user",
            content: message
        });
        
        showTypingIndicator();

        // First try ai.aerioncloud.com/v1/images/generations
        fetch('https://ai.aerioncloud.com/v1/images/generations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model: "flux",
                prompt: prompt,
                n: 1,
                size: "512x512"
            })
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to generate image');
            return response.json();
        })
        .then(data => {
            if (data.data && data.data[0] && data.data[0].url) {
                // For aerioncloud, show image directly without cropping
                const img = new Image();
                img.onload = function() {
                    hideTypingIndicator();
                    addMessage(data.data[0].url, 'ai', true);
                    conversationHistory.push({
                        role: "assistant",
                        content: `Here's your generated image: ${data.data[0].url}`
                    });
                    localStorage.setItem('bobisai_conversation', JSON.stringify(conversationHistory));
                    
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    isAIResponding = false;
                    messageInput.focus();
                };
                img.onerror = function() {
                    throw new Error('Failed to load aerioncloud image');
                };
                img.src = data.data[0].url;
            } else {
                throw new Error('Invalid response from aerioncloud');
            }
        })
        .catch(error => {
            console.log("ai.aerioncloud.com failed, falling back to pollinations.ai", error);
            // Fallback to pollinations.ai
            const encodedPrompt = encodeURIComponent(prompt);
            const pollinationsImage = new Image();
            pollinationsImage.crossOrigin = "Anonymous";
            
            pollinationsImage.onload = function() {
                // Only crop for pollinations.ai images
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate dimensions (cropping 10% from bottom)
                const cropHeight = Math.floor(pollinationsImage.height * 0.9);
                canvas.width = pollinationsImage.width;
                canvas.height = cropHeight;
                
                // Draw image (cropping bottom portion)
                ctx.drawImage(pollinationsImage, 0, 0, pollinationsImage.width, cropHeight, 
                             0, 0, pollinationsImage.width, cropHeight);
                
                // Get cropped image as data URL
                const croppedImageUrl = canvas.toDataURL('image/png');
                
                hideTypingIndicator();
                addMessage(croppedImageUrl, 'ai', true);
                conversationHistory.push({
                    role: "assistant",
                    content: `Here's your generated image: ${croppedImageUrl}`
                });
                localStorage.setItem('bobisai_conversation', JSON.stringify(conversationHistory));
                
                messageInput.disabled = false;
                sendButton.disabled = false;
                isAIResponding = false;
                messageInput.focus();
            };
            
            pollinationsImage.onerror = function() {
                hideTypingIndicator();
                addMessage("Sorry, I couldn't generate an image for that prompt.", 'ai');
                messageInput.disabled = false;
                sendButton.disabled = false;
                isAIResponding = false;
                messageInput.focus();
            };
            
            pollinationsImage.src = `https://image.pollinations.ai/prompt/${encodedPrompt}`;
        });
        
        return;
    }
                
                // Regular text message handling
                messageInput.disabled = true;
                sendButton.disabled = true;
                isAIResponding = true;
    
                if (!welcomeMessage.classList.contains('hidden')) {
                    welcomeMessage.classList.add('hidden');
                }
    
                addMessage(message, 'user');
                conversationHistory.push({
                    role: "user",
                    content: message
                });
                
                messageInput.value = '';
                showTypingIndicator();
    
                fetch('https://text.pollinations.ai/openai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        //model: "llama-3.2-11b-vision-instruct",
                        messages: conversationHistory,
                        temperature: 0.7,
                        max_tokens: 100000
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hideTypingIndicator();
                    
                    if (data.choices && data.choices[0] && data.choices[0].message) {
                        if (data.choices && data.choices[0] && data.choices[0].message) {
    let aiResponse = data.choices[0].message.content;
    
    // Remove everything after --- if it exists
    if (aiResponse.includes('---')) {
        aiResponse = aiResponse.split('---')[0].trim();
    }
    
    // Remove pollinations.ai links
    aiResponse = aiResponse.replace(/\[Learn more\]\(https:\/\/pollinations\.ai\/[^)]*\)/gi, '');
    aiResponse = aiResponse.replace(/https:\/\/pollinations\.ai\/[^\s)]*/gi, '');
    aiResponse = aiResponse.replace(/\[([^\]]+)\]\(https:\/\/pollinations\.ai\/[^)]*\)/gi, '$1');
    
    // Clean up any double newlines or spaces left after removal
    aiResponse = aiResponse.replace(/\n\s*\n/g, '\n').trim();
    
    conversationHistory.push({
        role: "assistant",
        content: aiResponse
    });
    simulateTyping(aiResponse, 'ai');
    
    localStorage.setItem('bobisai_conversation', JSON.stringify(conversationHistory));
}
                    } else {
                        showTypingIndicator();
                            // Retry logic (max 2 retries)
    let retries = 0;
    const maxRetries = 2;
    
    const retryRequest = () => {
        if (retries >= maxRetries) {
            hideTypingIndicator();
            addMessage("Sorry, I'm having trouble connecting. Please try again later.", 'ai');
            messageInput.disabled = false;
            sendButton.disabled = false;
            isAIResponding = false;
            return;
        }
        
        retries++;
        console.log(`Retrying... Attempt ${retries}`);
        
        fetch('https://text.pollinations.ai/openai', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                messages: conversationHistory,
                temperature: 0.7,
                max_tokens: 100000
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.choices && data.choices[0] && data.choices[0].message) {
                const aiResponse = data.choices[0].message.content;
                conversationHistory.push({
                    role: "assistant",
                    content: aiResponse
                });
                simulateTyping(aiResponse, 'ai');
                localStorage.setItem('bobisai_conversation', JSON.stringify(conversationHistory));
            } else {
                setTimeout(retryRequest, 1000 * retries); // Wait longer between retries
            }
        })
        .catch(error => {
            setTimeout(retryRequest, 1000 * retries); // Wait longer between retries
        });
    };
    
    setTimeout(retryRequest, 1000); // First retry after 1 second
                    }
                })
                .catch(error => {
                    hideTypingIndicator();
                    addMessage("Error connecting to the AI service. Please try again.", 'ai');
                    console.error('Error:', error);
                    
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    isAIResponding = false;
                    messageInput.focus();
                });
            }
    
            // Event listeners (unchanged)
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            modelDropdownBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleDropdown();
            });
            document.querySelectorAll('.model-option').forEach(option => {
                option.addEventListener('click', function() {
                    changePersonality(this.dataset.model);
                });
            });
            document.addEventListener('click', closeDropdown);
            settingsBtn.addEventListener('click', toggleSettings);
            closeSettings.addEventListener('click', toggleSettings);
            overlay.addEventListener('click', toggleSettings);
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    applyTheme(this.dataset.theme);
                });
            });
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (currentTheme === 'system') {
                    applyTheme('system');
                }
            });
    
            // Initialize (unchanged)
            messageInput.focus();
            applyTheme(currentTheme);
            loadConversation();
        });
    </script>
        <div class="warning-container" id="warning-container">
            <div class="warning-box">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <div class="warning-title">Content Warning</div>
                <div class="warning-text">
                    Your message contains inappropriate content. Please keep the conversation respectful.
                </div>
                <div class="warning-count" id="warning-count">Warning 1/10</div>
                <div class="warning-progress">
                    <div class="warning-progress-bar" id="warning-progress"></div>
                </div>
                <button class="warning-button" id="warning-acknowledge">I Understand</button>
            </div>
        </div>
        
        <div class="ban-container" id="ban-container" style="display: none;">
            <div class="ban-icon">üö´</div>
            <div class="ban-title">ACCOUNT SUSPENDED</div>
            <div class="ban-text">
                You have been permanently banned from using BobIsAI due to repeated violations of our content policy.
            </div>
            <div class="ban-details">
                <p><strong>Reason:</strong> Excessive inappropriate content (10 warnings issued)</p>
                <p><strong>Ban Type:</strong> Permanent (no appeals)</p>
            </div>
            <div class="ban-countdown" id="ban-countdown"></div>
        </div>
</body>
</html>
