<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Webhook Endpoint</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .endpoint {
            background: #e7f3fe;
            padding: 15px;
            border-left: 6px solid #2196F3;
            margin: 20px 0;
        }
        #debug {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 6px solid #ffc107;
            display: none;
        }
    </style>
</head>
<body>
    <h1>AI Webhook Endpoint</h1>
    <p>This page acts as a webhook that processes incoming messages through the DeepSeek R1 model.</p>
    
    <div class="endpoint">
        <h2>Endpoint Information</h2>
        <p><strong>URL:</strong> This page's URL</p>
        <p><strong>Method:</strong> POST</p>
        <p><strong>Content-Type:</strong> application/json</p>
        <p><strong>Request Body:</strong> <code>{"message": "Your message here"}</code></p>
    </div>

    <button onclick="testWebhook()">Test Webhook Locally</button>
    <div id="debug"></div>

    <script>
        async function callAI(message) {
            try {
                const response = await fetch('https://ai.aerioncloud.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "deepseek-r1",
                        messages: [{
                            role: "user",
                            content: message
                        }],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('AI API Error:', error);
                throw error;
            }
        }

        async function handleRequest(request) {
            if (request.method === 'POST') {
                try {
                    const data = await request.json();
                    
                    if (!data.message) {
                        return new Response(JSON.stringify({ error: "Message field is required" }), {
                            status: 400,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }
                    
                    const aiResponse = await callAI(data.message);
                    
                    return new Response(JSON.stringify({ response: aiResponse }), {
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                } catch (error) {
                    return new Response(JSON.stringify({ 
                        error: error.message,
                        details: "Check if the AI endpoint is available and CORS is properly configured"
                    }), {
                        status: 500,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }
            }
            
            return new Response(null, {
                status: 200,
                headers: { 'Content-Type': 'text/html' }
            });
        }

        // Test function for debugging
        async function testWebhook() {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML = '<p>Testing connection to AI endpoint...</p>';

            try {
                const testMessage = "Hello, how are you?";
                debugDiv.innerHTML += `<p>Sending test message: "${testMessage}"</p>`;
                
                const startTime = Date.now();
                const response = await callAI(testMessage);
                const duration = Date.now() - startTime;
                
                debugDiv.innerHTML += `
                    <p><strong>Success!</strong> Received response in ${duration}ms</p>
                    <p><strong>AI Response:</strong> ${response}</p>
                    <p>If this test works but your webhook doesn't, check:</p>
                    <ul>
                        <li>Your webhook URL is correct</li>
                        <li>You're sending a POST request</li>
                        <li>Your Content-Type header is set to application/json</li>
                        <li>Your request body contains a "message" field</li>
                    </ul>
                `;
            } catch (error) {
                debugDiv.innerHTML += `
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Troubleshooting steps:</p>
                    <ol>
                        <li>Check your internet connection</li>
                        <li>Verify the AI endpoint is available: <a href="https://ai.aerioncloud.com/v1/chat/completions" target="_blank">Test endpoint</a></li>
                        <li>Check browser console for CORS errors (F12 > Console)</li>
                        <li>Try from a different network (might be blocked by firewall)</li>
                    </ol>
                    <p>If you're seeing CORS errors, you'll need to deploy this as a server-side solution.</p>
                `;
            }
        }

        // Service Worker-like functionality
        if (typeof addEventListener === 'function') {
            addEventListener('fetch', event => {
                event.respondWith(handleRequest(event.request));
            });
        }
    </script>
</body>
</html>
